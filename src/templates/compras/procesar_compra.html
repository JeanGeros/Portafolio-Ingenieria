{% extends 'layout.html' %}
{% load widget_tweaks %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/procesar_compra.css' %}">
    
    <div class="container p-5 caja rounded">
        <div class="row mt-3">
            <div class="col">
                <h1 class="d-flex justify-content-center mb-3">Tu Compra</h1>
                <div class="row justify-content-between">
                    <div class="col-md-4 mb-2">
                        <a href="{% url 'comprar' %}" class="btn btn-info btn-block">Seguir comprando</a>
                    </div>
                </div>
                <form id="procesar-pago" method="post" action="#" class="p-3" name="formulario">
                    {% csrf_token %}
                    <div id="procesar-carrito" class="table-responsive">
                        <table class="table table-striped table-hover" id="lista-compra" style="background-color: white">
                            <thead class="table-dark" style="text-align:center">
                                <tr>
                                    <th scope="col">Imagen</th>
                                    <th scope="col">Nombre</th>
                                    <th scope="col">Precio</th>
                                    <th scope="col">Cantidad</th>
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody style="text-align:center">

                            </tbody>
                            <tr>
                                <th colspan="4" scope="col" class="text-right">TOTAL EN DOLARES : </th>
                                <th scope="col">
                                    <p id="dolar"></p>
                                </th>
                                <!-- <th scope="col"></th> -->
                            </tr>
                            <tr>
                                <th colspan="4" scope="col" class="text-right">TOTAL EN PESOS: </th>
                                <th scope="col">
                                    <p id="totalCLP"></p>
                                </th>
                                <!-- <th scope="col"></th> -->
                            </tr>
                            
                        </table>
                    </div>

                    <!-- <div class="row justify-content-center" id="loaders">
                        <img id="cargando" src="{% static 'images/cargando.gif' %}" width="220">
                    </div> -->

                </form>

            </div>
        </div>
    
        <div class="container text-center" style="padding-bottom: 30px;">
            <span id="email" class="p-3 text-center font-weight-bold border border-secondary">Enviaremos el resumen de tu compra al correo: {{request.user.email}}</span>
        </div>

        <h1 class="text-center">Realiza tu pago con PayPal</h1>
        <div class="container pt-3 pb-2 text-center">
        {% comment %} <h1>Realizar Pago</div> {% endcomment %}
        
        <div class="container p-3 text-center" id="paypal-button-container"></div>
    </div>

    <script src="{% static 'js/procesar_compra.js' %}"></script>

    <div class="container p-3 text-center" id="paypal-button-container"></div>
        <script src="https://www.paypal.com/sdk/js?client-id=AaFsPq2UDLSQ893pug798ZtxfL5tWsgU3x2gzaGoL6mu9ZITTIZ55lwMq3YWegB3JU4Jjwub3Htt5oCG"></script>
        <script>
            
            paypal.Buttons({
                createOrder: function(data, actions) {
                // This function sets up the details of the transaction, including the amount and line item details.
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: document.getElementById('dolar').textContent
                                
                            }
                        }]
                    });
                },
                onApprove: function(data, actions) {
                // This function captures the funds from the transaction.
                    
                    return actions.order.capture().then(function(details) {
                        console.log('realizada')
                        document.formulario.submit();
                        
                        vaciarLocalStorage();
                        // This function shows a transaction success message to your buyer.
                        //alert('Transaction completed by ' + details.payer.name.given_name);
                        // const compra = new Carrito();
                        
                        //const boleta = 'Hola \n' + document.getElementById('username').textContent.substr(11) +
                        //'El total de su compra es: ' + document.getElementById('dolar').textContent;
                        // const username = document.getElementById('username').textContent.substr(11);
                        // const total = document.getElementById('total').textContent;
                        // const totalDolar = document.getElementById('dolar').textContent;
                        // const correo = document.getElementById('email').textContent.substr(11);
                        
                        // Email.send({
                        //     Host : "smtp.gmail.com",
                        //     Username : "elkioskitoltda@gmail.com",
                        //     Password : "kioskito1234",
                        //     From : "elkioskitoltda@gmail.com",
                        //     To : correo,
                        //     Subject : "Detalle de compra, El Kioskito",
                        //     Body : `<p>Hola ${username}</p><br>
                        //     <p>el total de tu compra es: $${total}</p><br>
                        //     <p>el total de tu compra en dolares es: $${totalDolar}</p><br>
                        //     <p>Proximamente agregaremos el detalle completo de tu compra.</p><br><br>
                        //     <p>Saludos.</p><br>
                        //     `
                        // });

                        // Swal.fire({
                        //     type: 'success',
                        //     title: 'El pago se ha realizado con exito',
                        //     text: 'Lo redigiremos en un momento',
                        //     showConfirmButton: false,
                        //     timer: 4000
                        // })
                        // setTimeout(() => {
                        //     window.location = "../../venta/";
                        // }, 5000);
                        
                        
                        // formulario.submit();
                        // vaciarLocalStorage();
                    });
                }
            }).render('#paypal-button-container');
            //This function displays Smart Payment Buttons on your web page.
        </script>
    </div>
    

{% endblock %}